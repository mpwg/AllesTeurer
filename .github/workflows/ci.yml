name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Build and test Android and shared Kotlin code on Ubuntu
  android-and-shared:
    name: Build Android & Shared
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Cache Kotlin/Native dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.konan
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-kotlin-native-${{ hashFiles('**/*.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-kotlin-native-

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Build shared module
        run: ./gradlew :shared:build --no-daemon --parallel --build-cache

      - name: Build Android app
        run: ./gradlew :composeApp:assembleDebug --no-daemon --parallel --build-cache

      - name: Run unit tests
        run: ./gradlew test --no-daemon --parallel --build-cache

      - name: Run Android tests
        run: ./gradlew :composeApp:testDebugUnitTest --no-daemon --parallel --build-cache

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-test-reports
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: android-apk
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 7

  # Build iOS on macOS
  ios:
    name: Build iOS
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Cache Kotlin/Native dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.konan
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-kotlin-native-${{ hashFiles('**/*.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-kotlin-native-

      - name: Cache Xcode derived data
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-derived-data-${{ hashFiles('iosApp/**/*.swift', 'iosApp/iosApp.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-xcode-derived-data-

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Build shared framework for iOS
        run: ./gradlew :shared:linkDebugFrameworkIosArm64 :shared:linkDebugFrameworkIosSimulatorArm64 --no-daemon --parallel --build-cache

      - name: Build iOS Kotlin framework
        run: ./gradlew :composeApp:linkDebugFrameworkIosArm64 :composeApp:linkDebugFrameworkIosSimulatorArm64 --no-daemon --parallel --build-cache

      - name: Run iOS tests
        run: ./gradlew :composeApp:iosSimulatorArm64Test --no-daemon --parallel --build-cache

      - name: Build iOS app for simulator
        run: |
          cd iosApp
          xcodebuild -project iosApp.xcodeproj -scheme iosApp -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' build

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-test-reports
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

  # Lint and code quality checks
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle.kts', 'gradle/wrapper/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Kotlin linter
        run: ./gradlew ktlintCheck --no-daemon --parallel

      - name: Run detekt
        run: ./gradlew detekt --no-daemon --parallel
        continue-on-error: true

      - name: Upload lint reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports
          path: |
            **/build/reports/ktlint/
            **/build/reports/detekt/
          retention-days: 7

  # Security and dependency checks
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  # Build summary and status
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [android-and-shared, ios, lint, security]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "Android & Shared build: ${{ needs.android-and-shared.result }}"
          echo "iOS build: ${{ needs.ios.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"

          if [[ "${{ needs.android-and-shared.result }}" == "failure" || "${{ needs.ios.result }}" == "failure" ]]; then
            echo "❌ Build failed"
            exit 1
          elif [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "⚠️ Build succeeded but linting failed"
            exit 1
          else
            echo "✅ All builds succeeded"
          fi
