# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Load environment variables from .env file if it exists, otherwise use system environment variables
env_file_path = File.join(File.dirname(__FILE__), '..', '.env')
if File.exist?(env_file_path)
  require 'dotenv'
  Dotenv.load(env_file_path)
  UI.message("üìÑ Loaded environment variables from .env file")
else
  UI.message("üåç Using system environment variables (no .env file found)")
end

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# Global configuration
APP_IDENTIFIER = "eu.mpwg.Alles-Teurer"
SCHEME_NAME = "Alles-Teurer"
WORKSPACE_PATH = "./Alles-Teurer.xcodeproj"

platform :ios do
  before_all do

    # Setup keychain for CI
    if is_ci
      create_keychain(
        name: "CI",
        password: ENV["KEYCHAIN_PASSWORD"],
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end
  end

  after_all do |lane|
    # Clean up keychain on CI
    if is_ci
      delete_keychain(name: "CI")
    end
  end

  error do |lane, exception|
    # Clean up keychain on CI even if there's an error
    if is_ci
      delete_keychain(name: "CI") rescue nil
    end
  end

  # MARK: - Development Builds

  desc "Build development version for testing"
  lane :dev do
    setup_ci_if_needed

    sync_certificates(type: "development")

    build_app(common_build_config.merge({
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/development",
      output_name: "#{SCHEME_NAME}-development.ipa",
      skip_profile_detection: false
    }))

    UI.success("‚úÖ Development build completed successfully!")
  end

  # MARK: - Beta Builds (TestFlight)

  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci_if_needed

    # Increment build number
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: WORKSPACE_PATH
    )

    sync_certificates(type: "appstore")

    build_app(common_build_config.merge({
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build/testflight",
      output_name: "#{SCHEME_NAME}-testflight.ipa",
      skip_profile_detection: true
    }))

    upload_to_testflight(
      app_identifier: APP_IDENTIFIER,
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "Bug fixes and improvements"
    )

    UI.success("‚úÖ TestFlight upload completed successfully!")
  end

  # MARK: - Production Builds (App Store)

  desc "Build and upload to App Store"
  lane :release do
    setup_ci_if_needed

    # Ensure we're on main branch for releases
    ensure_git_branch(branch: 'main')

    # Increment version number (patch version)
    increment_version_number(
      bump_type: "patch",
      xcodeproj: WORKSPACE_PATH
    )

    # Increment build number
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: WORKSPACE_PATH
    )

    sync_certificates(type: "appstore")

    build_app(common_build_config.merge({
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build/appstore",
      output_name: "#{SCHEME_NAME}-appstore.ipa",
      skip_profile_detection: true
    }))

    upload_to_app_store(
      app_identifier: APP_IDENTIFIER,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false, # Manual submission for production
      automatic_release: false,
      force: true
    )

    # Commit version bump
    commit_version_bump(
      message: "Version bump for App Store release",
      xcodeproj: WORKSPACE_PATH
    )

    # Add git tag
    add_git_tag(
      tag: get_version_number(xcodeproj: WORKSPACE_PATH)
    )

    UI.success("‚úÖ App Store upload completed successfully!")
    UI.success("üè∑Ô∏è  Tagged version: #{get_version_number(xcodeproj: WORKSPACE_PATH)}")
  end

  # MARK: - Testing

  desc "Run unit tests and build for CI validation"
  lane :test do
    UI.message("üß™ Running unit tests with Mac Catalyst for maximum speed")
    
    # Clean build directory first
    sh("rm -rf ../build/test-results || true")
    sh("mkdir -p ../build/test-results")
    
    # Build and test with Mac Catalyst using xcodebuild directly
    # This is 5x faster than iOS simulator as it runs natively on macOS
    sh("set -o pipefail && xcodebuild test -project ../#{WORKSPACE_PATH} -scheme #{SCHEME_NAME} -destination 'platform=macOS,variant=Mac Catalyst' -resultBundlePath ../build/test-results/Alles-Teurer-Catalyst.xcresult CODE_SIGNING_ALLOWED=NO -allowProvisioningUpdates #{build_xcargs} | xcpretty || true")

    UI.success("‚úÖ Mac Catalyst tests completed!")
  end

  desc "Run tests on iOS Simulator (manual use for iOS-specific testing)"
  lane :test_ios do
    UI.message("üß™ Running tests on iOS Simulator for iOS-specific testing")
    
    # iOS Simulator testing for iOS-specific functionality
    run_tests(
      project: WORKSPACE_PATH,
      scheme: SCHEME_NAME,
      devices: ["iPhone 17"],  # Keep iPhone 17 as requested
      clean: false,  # Keep incremental builds for speed
      code_coverage: false,  # Disable coverage for faster execution
      skip_build: false,
      result_bundle: true,
      output_directory: "./build/test-results-ios",
      buildlog_path: "./build/logs",
      xcargs: "CODE_SIGNING_ALLOWED=NO -allowProvisioningUpdates #{build_xcargs}"
    )

    UI.success("‚úÖ iOS Simulator tests completed successfully!")
  end

  # MARK: - Build Only (for CI validation)

  desc "Build app without distribution (for CI validation)"
  lane :build do
    setup_ci_if_needed

    # Use Mac Catalyst for faster builds (no code signing needed for validation)
    UI.message("üèóÔ∏è Building with Mac Catalyst for fast CI validation")
    
    sh("set -o pipefail && xcodebuild build -project ../#{WORKSPACE_PATH} -scheme #{SCHEME_NAME} -destination 'platform=macOS,variant=Mac Catalyst' CODE_SIGNING_ALLOWED=NO -allowProvisioningUpdates #{build_xcargs} | xcpretty")

    UI.success("‚úÖ Mac Catalyst build validation completed successfully!")
  end

  desc "Build app for iOS distribution"
  lane :build_ios do
    setup_ci_if_needed

    sync_certificates(type: "development")

    build_app(common_build_config.merge({
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/validation",
      output_name: "#{SCHEME_NAME}-validation.ipa",
      skip_profile_detection: true,
      skip_archive: false
    }))

    UI.success("‚úÖ iOS build validation completed successfully!")
  end

  desc "Clean build when incremental builds are causing issues"
  lane :clean_build do
    setup_ci_if_needed

    sync_certificates(type: "development")

    build_app(common_build_config.merge({
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/validation",
      output_name: "#{SCHEME_NAME}-clean-build.ipa",
      skip_profile_detection: true,
      skip_archive: false,
      clean: true  # Force clean build
    }))

    UI.success("‚úÖ Clean build completed successfully!")
  end

  # MARK: - Code Signing

  desc "Sync development certificates and provisioning profiles"
  lane :certificates do
    setup_ci_if_needed
    sync_certificates(type: "development")
    sync_certificates(type: "appstore")
  end

  desc "Update certificates and push to git"
  lane :update_certificates do
    configure_app_store_connect
    UI.success("DEBUG: Before updating certificates")

    match(
      type: "development",
      app_identifier: APP_IDENTIFIER,
      git_url: ENV["MATCH_GIT_URL"],
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
      force_for_new_devices: true,
      readonly: false,
      verbose: true
    )
    UI.success("DEBUG: After updating development certificates")
    match(
      type: "appstore",
      app_identifier: APP_IDENTIFIER,
      git_url: ENV["MATCH_GIT_URL"],
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
      readonly: false,
      verbose: true
    )
    UI.success("‚úÖ Certificates updated and pushed to git!")
  end

  # MARK: - Helper Methods

  private_lane :setup_ci_if_needed do
    if is_ci
      setup_ci
    end
  end

  private_lane :common_build_config do
    {
      scheme: SCHEME_NAME,
      project: WORKSPACE_PATH,
      clean: false,  # Improved: Only clean when necessary for faster incremental builds
      include_bitcode: false,
      # Let match determine the identity and profile
      codesigning_identity: "",  # Let match determine the identity
      export_xcargs: "-allowProvisioningUpdates",
      # Performance optimizations
      xcargs: build_xcargs
    }
  end

  private_lane :build_xcargs do
    args = []
    
    # Enable parallel builds for faster compilation
    args << "-jobs #{ENV.fetch('FASTLANE_BUILD_JOBS', `sysctl -n hw.logicalcpu`.strip)}"
    
    # Use optimized linker for faster linking
    args << "OTHER_LDFLAGS=\"-Wl,-no_deduplicate\""
    
    # Enable build caching
    args << "CLANG_ENABLE_MODULE_DEBUGGING=NO"  # Faster for CI builds
    
    # Swift compilation optimizations
    args << "SWIFT_COMPILATION_MODE=incremental" if !is_ci
    
    args.join(" ")
  end

  private_lane :configure_app_store_connect do
    if ENV["FASTLANE_SESSION"]
      UI.message("üîë Using FASTLANE_SESSION for App Store Connect authentication")
    else
      UI.message("‚ö†Ô∏è  FASTLANE_SESSION not configured - some operations may require manual authentication")
    end
  end

  private_lane :sync_certificates do |options|
    type = options[:type]

    # Validate required environment variables
    required_match_vars = ["MATCH_GIT_URL", "MATCH_PASSWORD"]
    missing_vars = required_match_vars.select { |var| ENV[var].nil? || ENV[var].empty? }

    if missing_vars.any?
      UI.error("‚ùå Missing required environment variables for fastlane match: #{missing_vars.join(', ')}")
      UI.error("üí° Please check your .env file or environment configuration")
      raise "Missing required environment variables for code signing"
    end

    # Configure App Store Connect authentication if available (required for creating new certificates)
    configure_app_store_connect

    UI.message("üîê Syncing #{type} certificates and provisioning profiles with fastlane match")
    UI.message("üöß Ensuring Fastlane handles code signing (not Xcode automatic signing)")

    begin
      match(
        type: type,
        app_identifier: APP_IDENTIFIER,
        git_url: ENV["MATCH_GIT_URL"],
        git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
        keychain_name: is_ci ? "CI" : nil,
        keychain_password: is_ci ? ENV["KEYCHAIN_PASSWORD"] : nil,
        readonly: is_ci,
        verbose: true,
        # Ensure Fastlane manages signing, not Xcode
        skip_confirmation: true,
        shallow_clone: true
      )
      UI.success("‚úÖ Successfully synced #{type} certificates")
      UI.message("üîí Code signing will be handled by Fastlane, not Xcode")
    rescue => e
      UI.error("‚ùå Failed to sync certificates: #{e.message}")
      UI.error("üí° Common solutions:")
      UI.error("   ‚Ä¢ Check MATCH_PASSWORD is correct")
      UI.error("   ‚Ä¢ Verify MATCH_GIT_URL is accessible")
      UI.error("   ‚Ä¢ Ensure certificates exist in match repository")
      UI.error("   ‚Ä¢ Run 'fastlane update_certificates' if certificates need to be created")
      raise e
    end
  end

  # MARK: - Utility Lanes

  desc "Show current version and build number"
  lane :version do
    version = get_version_number(xcodeproj: WORKSPACE_PATH)
    build = get_build_number(xcodeproj: WORKSPACE_PATH)
    UI.message("üì± Current version: #{version} (#{build})")
  end

  desc "Show available lanes"
  lane :show_help do
    UI.header("üìã Available Fastlane Lanes")
    UI.message("üß™ Testing:")
    UI.message("  ‚Ä¢ fastlane test       - Run unit tests and build for CI validation")
    UI.message("")
    UI.message("üî® Development:")
    UI.message("  ‚Ä¢ fastlane dev        - Build development version")
    UI.message("  ‚Ä¢ fastlane build      - Build for CI validation")
    UI.message("  ‚Ä¢ fastlane clean_build - Clean build when incremental builds fail")
    UI.message("")
    UI.message("üß™ Testing:")
    UI.message("  ‚Ä¢ fastlane beta       - Build and upload to TestFlight")
    UI.message("")
    UI.message("üöÄ Production:")
    UI.message("  ‚Ä¢ fastlane release    - Build and upload to App Store")
    UI.message("")
    UI.message("üîê Code Signing:")
    UI.message("  ‚Ä¢ fastlane certificates        - Sync existing certificates")
    UI.message("  ‚Ä¢ fastlane update_certificates - Update and push new certificates")
    UI.message("")
    UI.message("‚ÑπÔ∏è  Utility:")
    UI.message("  ‚Ä¢ fastlane version   - Show current app version")
    UI.message("  ‚Ä¢ fastlane benchmark - Run build performance benchmark")
    UI.message("  ‚Ä¢ fastlane show_help - Show this help")
  end

  desc "Run build performance benchmark"
  lane :benchmark do
    UI.header("üöÄ Build Performance Benchmark")
    
    start_time = Time.now
    
    # Clean build for baseline
    UI.message("Running clean build benchmark...")
    clean_start = Time.now
    
    build_app(common_build_config.merge({
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/benchmark",
      output_name: "#{SCHEME_NAME}-benchmark-clean.ipa",
      skip_profile_detection: true,
      skip_archive: true,
      clean: true
    }))
    
    clean_duration = Time.now - clean_start
    
    # Incremental build
    UI.message("Running incremental build benchmark...")
    incremental_start = Time.now
    
    build_app(common_build_config.merge({
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build/benchmark",
      output_name: "#{SCHEME_NAME}-benchmark-incremental.ipa",
      skip_profile_detection: true,
      skip_archive: true,
      clean: false
    }))
    
    incremental_duration = Time.now - incremental_start
    total_duration = Time.now - start_time
    
    UI.success("üìä Build Performance Results:")
    UI.success("  ‚Ä¢ Clean build time: #{clean_duration.round(2)} seconds")
    UI.success("  ‚Ä¢ Incremental build time: #{incremental_duration.round(2)} seconds")
    UI.success("  ‚Ä¢ Time saved with incremental builds: #{(clean_duration - incremental_duration).round(2)} seconds")
    UI.success("  ‚Ä¢ Total benchmark time: #{total_duration.round(2)} seconds")
    UI.success("  ‚Ä¢ Performance improvement: #{((clean_duration - incremental_duration) / clean_duration * 100).round(1)}%")
  end
end